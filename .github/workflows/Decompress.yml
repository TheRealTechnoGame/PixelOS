name: Decompress archives on push

on:
  push:
    paths:
      - '**/*.zip'
      - '**/*.tar'
      - '**/*.tar.gz'
      - '**/*.tgz'
      - '**/*.tar.bz2'
      - '**/*.tar.xz'

permissions:
  contents: write  # <--- Autoriser le push au bot

jobs:
  decompress:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NÃ©cessaire pour git diff

      - name: Find and decompress newly added or modified archives and commit extracted files
        shell: bash
        run: |
          set -e

          shopt -s globstar nullglob

          last_author=$(git log -1 --pretty=format:'%an')
          if [[ "$last_author" == "github-actions[bot]" ]]; then
            echo "Last commit made by github-actions[bot], skipping decompression to avoid loop."
            exit 0
          fi

          files=$(git diff --name-only --diff-filter=AM "${{ github.event.before }}" "${{ github.sha }}" || true)

          archives=()
          for file in $files; do
            if [[ "$file" == *.zip || "$file" == *.tar || "$file" == *.tar.gz || "$file" == *.tgz || "$file" == *.tar.bz2 || "$file" == *.tar.xz ]]; then
              archives+=("$file")
            fi
          done

          if [ ${#archives[@]} -eq 0 ]; then
            echo "No new or modified archive files to decompress."
            exit 0
          fi

          for archive in "${archives[@]}"; do
            echo "Decompressing $archive"

            case "$archive" in
              *.tar.gz) dir="${archive%.tar.gz}" ;;
              *.tar.bz2) dir="${archive%.tar.bz2}" ;;
              *.tar.xz) dir="${archive%.tar.xz}" ;;
              *.tgz) dir="${archive%.tgz}" ;;
              *) dir="${archive%.*}" ;;
            esac

            mkdir -p "$dir"

            case "$archive" in
              *.zip) unzip -q "$archive" -d "$dir" ;;
              *.tar) tar -xf "$archive" -C "$dir" ;;
              *.tar.gz|*.tgz) tar -xzf "$archive" -C "$dir" ;;
              *.tar.bz2) tar -xjf "$archive" -C "$dir" ;;
              *.tar.xz) tar -xJf "$archive" -C "$dir" ;;
            esac
          done

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add -A

          if ! git diff --cached --quiet; then
            git commit -m "Add decompressed files from newly uploaded archives [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
