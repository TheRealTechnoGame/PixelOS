name: Decompress archives on push

on:
  push:
    paths:
      - '**/*.zip'
      - '**/*.tar'
      - '**/*.tar.gz'
      - '**/*.tgz'
      - '**/*.tar.bz2'
      - '**/*.tar.xz'

jobs:
  decompress:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # <--- Important : récupérer tout l’historique pour éviter l’erreur "bad object"

      - name: Find and decompress newly added or modified archives and commit extracted files
        shell: bash
        run: |
          set -e

          # Activer les options shell pour globstar (**) et gérer les tableaux vides
          shopt -s globstar nullglob

          # Empêcher la boucle infinie si le dernier commit a été fait par github-actions[bot]
          last_author=$(git log -1 --pretty=format:'%an')
          if [[ "$last_author" == "github-actions[bot]" ]]; then
            echo "Last commit made by github-actions[bot], skipping decompression to avoid loop."
            exit 0
          fi

          # Récupérer la liste des fichiers ajoutés ou modifiés entre les deux commits
          files=$(git diff --name-only --diff-filter=AM "${{ github.event.before }}" "${{ github.sha }}" || true)

          # Filtrer uniquement les fichiers archives
          archives=()
          for file in $files; do
            if [[ "$file" == *.zip || "$file" == *.tar || "$file" == *.tar.gz || "$file" == *.tgz || "$file" == *.tar.bz2 || "$file" == *.tar.xz ]]; then
              archives+=("$file")
            fi
          done

          if [ ${#archives[@]} -eq 0 ]; then
            echo "No new or modified archive files to decompress."
            exit 0
          fi

          # Décompresser chaque archive dans un dossier dédié
          for archive in "${archives[@]}"; do
            echo "Decompressing $archive"

            case "$archive" in
              *.tar.gz) dir="${archive%.tar.gz}_extracted" ;;
              *.tar.bz2) dir="${archive%.tar.bz2}_extracted" ;;
              *.tar.xz) dir="${archive%.tar.xz}_extracted" ;;
              *.tgz) dir="${archive%.tgz}_extracted" ;;
              *) dir="${archive%.*}_extracted" ;;
            esac

            mkdir -p "$dir"

            case "$archive" in
              *.zip)
                unzip -q "$archive" -d "$dir"
                ;;
              *.tar)
                tar -xf "$archive" -C "$dir"
                ;;
              *.tar.gz|*.tgz)
                tar -xzf "$archive" -C "$dir"
                ;;
              *.tar.bz2)
                tar -xjf "$archive" -C "$dir"
                ;;
              *.tar.xz)
                tar -xJf "$archive" -C "$dir"
                ;;
              *)
                echo "Unsupported archive format: $archive"
                ;;
            esac
          done

          # Configurer git pour le commit automatique
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Ajouter les fichiers extraits
          git add -A

          # Commit et push uniquement s'il y a des changements
          if ! git diff --cached --quiet; then
            git commit -m "Add decompressed files from newly uploaded archives [skip ci]"
            git push
          else
            echo "No changes to commit"
          fi
